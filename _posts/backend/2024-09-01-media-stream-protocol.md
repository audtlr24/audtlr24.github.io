---
layout: post
title: Media Stream Protocol
date: 2024-09-01 12:00:00 +0000
categories: backend
---
## 미디어 스트리밍 프로토콜

TCP 혹은 UDP 위에서 작동하며 동작 방식에 따라 여러 프로토콜이 존재함
- TCP 의 경우 3-way handshake가 있고 UDP 는 데이터를 바로 전송함
- 스트리밍 프로토콜 따라 데이터는 일정한 조각(Chunk) 단위로 전송됨
- 실시간 재생을 위한 버퍼링 전략등이 포함될 수 있음

## RTSP / RTP

### RTSP (Real-Time Streaming Protocol)
- RTP 이전에 스트리밍 세션을 제어하기 위한 프로토콜 계층
- HTTP와 유사한 응답 구조를 가짐

세션 설정 (SETUP)
- 클라이언트가 서버에 세션을 요청. URL, RTP 포트 정보를 포함함
플레이백 제어 (PLAY, PAUSE, TEARDOWN)
- 스트림을 재생할때(PLAY), 스트림을 일시정지 할때(PAUSE), 종료할 때(TEARDOWN) 서버에 명령을 보내서 RTP 스트림을 제어함
미디어 탐색 (DESCRIBE, ANNOUNCE)
- 클라이언트가 스트림의 메타데이터를 요청할때(DESCRIBE), 서버가 스트림의 새로운 정보를 전달할때(ANNOUNCE) 사용

### RTP (Real-time Transport Protocol)
- 실제 미디어 데이터를 전송하는 프로토콜
- UDP 위에서 작동하지만 패킷마다 타임스탬프, 순서 번호등의 메타데이터를 포함하여 신뢰성을 높임

### RTSP/RTP 스트리밍 절차

1. 세션 설정
   클라이언트는 RTSP 를 통해 서버에 접근하고 스트리밍 세션을 생성함. 이때 서버는 RTP 서버 포트를 할당
2. 스트리밍 시작
   클라이언트가 RTSP 'PLAY' 명령을 보내면 서버는 미디어 데이트를 RTP 패킷으로 변환하여 전송
3. 데이터 전송 및 재생
   클라이언트는 RTP 패킷을 타임스탬프와 순서 번호에 따라 재조합하여 실시간으로 재생
4. 스트리밍 제어
   RTSP 명령을 통해 제어가능
5. 세션 종료
   클라이언트가 RTSP 'TEARDOWN' 명령을 보내면 세션이 종료

### 라이브러리
- FFmpeg
- GStreamer
- node-rtp 

## HLS (HTTP Live Streaming)

### HLS 주요 특징

HTTP 기반
- HTTP 기반으로 하여 기존의 웹 인프라 (웹 서버, 캐시 서버, CDN 등)을 활용할 수 있음
- NAT 나 방화벽 뒤에서도 스트리밍이 원활히 작동할 수 있게 함
- 직접적인 소켓 연결이 아니고 일반적인 웹 요청 처럼 HTTP GET 으로 데이터를 요청

적응형 스트리밍
- 다양한 해상도, 비트레이트로 인코딩된 미디어 파일을 제공하고 네트워크 환경에 따라 최적화된 스트림 품질을 결정함

미디어 세그먼트
- HLS 는 전체 파일을 작은 조각으로 나눔 (일반적으로 10초)
- 각각의 세그먼트는 HTTP 서버에서 요청하고 다운로드 할수 있는 작은 미디어 파일
- .m3u8 의 세그먼트 메타데이터가 있고 세그먼트는 .ts 형태로 관리됨

### HLS 장단점

장점:
- 높은 호환성: HTTP 기반으로 기존의 웹 인프라와 잘 통합됨
- 적응형 스트리밍: 네트워크 상태에 따라 자동으로 스트림 품질 조정
- 보안: HTTPS를 통한 전송이 가능함

단점:
- 지연 시간: 세그먼트를 생성하는 최소시간이 있기 떄문에 지연시간이 있음
- 초기 버퍼링: 클라이언트는 안정적인 재생을 위해 몇개의 세그먼트를 먼저 다운로드 한 후 재생을 시작하기도 함. 실시간이라면 더 긴 지연 시간이 생길 수 있음

### RTP 와 HLS 사용 사례

RTP:
- 실시간 통신 - 지연이 중요한 실시간 애플리케케이션 (비디오 회의, 실시간 방송, CCTV) 에서 주로 사용
- 전용 네트워크 환경 - UDP 를 사용하는 특성상 패킷손실이 적은 환경에서 사용

HLS:
- 주류 스트리밍 플랫폼 - 넷플릭스, 유튜브와 같은 스트리밍 플랫폼에서 널리 사용됨
- 웹 & 모바일


## WebRTC (Web Real-Time Communication)

### 주요 특징
- WebRTC는 웹 애플리케이션과 웹 사이트에서 플로그인 없이 브라우저 간의 실시간 오디오 통신을 가능하게 하는 기술로 주로 P2P 통신을 통해 동작
- 저지연을 필요로 하는 응용 프로그램 (비디오 회의, 라이브 스트리밍 등)에 사용됨

### 구성 요소
- RTCPeerConnection
	- 클라이언트 간 P2P 연결을 설정하고 유지함. 실제 데이터 스트림을 전송
	- 연결과정에서 STUN/TURN 서버를 이용하여 연결 설정
- RTCDataChannel
	- 미디어 데이터가 아닌 다른 데이터 전송의 용도
	- 파일 전송, 채팅등의 데이터
- MediaStream
	- 웹캠, 마이크 등의 미디어 입력을 P2P 로 전송
- ICE (Interactive Connectivity Establishment)
	- 클라이언트 상호 간에 연결 가능한 적합한 경로를 찾는데 사용
- SRTP (Secure Real-time Transport Protocol)
	- 미디어 스트림을 암호화 하여 보안을 보장하는 역할

### WebRTC 에서 서버
기본 적으로는 P2P 통신이지만 해당 연결을 유지하는 과정에서 서버가 필요함

시그널링 서버 (Signaling Server)
- 클라이언트 간의 초기정보 (네트워크 정보, 미디어 설정 등) 을 교환하는데 사용됨
- SDP (Session Description Protocol) - 미디어 정보 (코덱, 해상도, 비트레이트)
- ICE 후보 - 각 클라이언트의 IP, Port

STUN 서버 (Session Traversal Utilities for NAT)
- NAT 뒤에 있는 클라이언트가 공용 IP 주소를 알아내고 다른 클라이언트와 직접적인 P2P 연결을 할 수 있게 도와줌

TURN 서버
- P2P 연결이 실패할 경우 클라이언트 간의 데이터를 중개하는 역할